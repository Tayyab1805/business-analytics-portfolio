<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lecture Notes - Business Analytics Hub</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/responsive.css">
    <link rel="stylesheet" href="css/lecture.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto:wght@300;400;500&family=Source+Code+Pro:wght@400;500&display=swap" rel="stylesheet">
    <!-- Highlight.js for code syntax -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
</head>
<body>
    <div id="navbar-container"></div>

    <main class="container">
        <div id="breadcrumb-container"></div>

        <div class="lecture-actions-bar">
            <div class="navigation-buttons">
                <button class="btn-prev" id="prev-lecture">
                    <i class="fas fa-arrow-left"></i> Previous
                </button>
                <button class="btn-next" id="next-lecture">
                    Next <i class="fas fa-arrow-right"></i>
                </button>
            </div>
            
            <div class="action-buttons">
                <button class="btn-print" onclick="window.print()">
                    <i class="fas fa-print"></i> Print
                </button>
                <button class="btn-download-full" id="download-pdf">
                    <i class="fas fa-file-pdf"></i> Download PDF
                </button>
            </div>
        </div>

        <div class="lecture-container">
            <!-- Table of Contents Sidebar -->
            <aside class="toc-sidebar" id="toc-sidebar">
                <h3><i class="fas fa-list"></i> Contents</h3>
                <div id="table-of-contents">
                    <!-- Generated by JavaScript -->
                </div>
                
                <div class="lecture-progress" style="margin-top: 30px;">
                    <div class="progress-info">
                        <span>Lecture Progress</span>
                        <span id="progress-percent">0%</span>
                    </div>
                    <div class="progress-bar-lecture">
                        <div class="progress-fill-lecture" id="progress-fill-lecture" style="width: 0%"></div>
                    </div>
                    <p style="margin-top: 10px; font-size: 0.9rem; color: var(--gray-color);">
                        <i class="far fa-clock"></i> Estimated reading time: <span id="reading-time">15 min</span>
                    </p>
                </div>
            </aside>

            <!-- Main Lecture Content -->
            <article class="lecture-content">
                <div class="lecture-header">
                    <h1 id="lecture-title">Loading Lecture...</h1>
                    <div class="lecture-meta" id="lecture-meta">
                        <!-- Filled by JavaScript -->
                    </div>
                </div>

                <div class="markdown-content" id="markdown-content">
                    <!-- Markdown content will be loaded here -->
                    <div class="loading-state">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading lecture content...</p>
                    </div>
                </div>
            </article>
        </div>

        <section class="related-lectures">
            <h2><i class="fas fa-book-open"></i> Related Lectures</h2>
            <div class="lectures-mini-grid" id="related-lectures">
                <!-- Filled by JavaScript -->
            </div>
        </section>
    </main>

    <div id="footer-container"></div>

    <!-- Load required libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- Our scripts -->
    <script src="js/markdown-converter.js"></script>
    <script src="js/pdf-generator.js"></script>
    
    <script>
        // Global variables
        let currentCourse = '';
        let currentLecture = 1;
        let totalLectures = 0;
        let markdownConverter = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            // Load components
            await loadComponents();
            
            // Get lecture parameters from URL
            const urlParams = new URLSearchParams(window.location.search);
            currentCourse = urlParams.get('course') || 'BA101';
            currentLecture = parseInt(urlParams.get('lecture')) || 1;
            
            // Initialize markdown converter
            markdownConverter = new MarkdownConverter();
            
            // Load lecture content
            await loadLecture(currentCourse, currentLecture);
            
            // Setup event listeners
            setupEventListeners();
            
            // Initialize syntax highlighting
            hljs.highlightAll();
        });

        // Load navbar, breadcrumb, footer
        async function loadComponents() {
            try {
                const [navbar, breadcrumb, footer] = await Promise.all([
                    fetch('components/navbar.html').then(r => r.text()),
                    fetch('components/breadcrumb.html').then(r => r.text()),
                    fetch('components/footer.html').then(r => r.text())
                ]);
                
                document.getElementById('navbar-container').innerHTML = navbar;
                document.getElementById('breadcrumb-container').innerHTML = breadcrumb;
                document.getElementById('footer-container').innerHTML = footer;
                
                // Set active nav
                setActiveNav('home');
                
            } catch (error) {
                console.error('Error loading components:', error);
            }
        }

        // Load lecture from markdown file
        async function loadLecture(courseId, lectureNumber) {
            try {
                // Show loading state
                document.getElementById('markdown-content').innerHTML = `
                    <div class="loading-state" style="text-align: center; padding: 50px;">
                        <i class="fas fa-spinner fa-spin fa-3x" style="color: var(--secondary-color);"></i>
                        <p style="margin-top: 20px;">Loading lecture ${lectureNumber}...</p>
                    </div>
                `;
                
                // Try to load the markdown file
                const response = await fetch(`content/semester1/${courseId}/lecture${lectureNumber}.md`);
                
                if (!response.ok) {
                    throw new Error('Lecture not found');
                }
                
                const markdown = await response.text();
                
                // Convert markdown to HTML
                const html = markdownConverter.convert(markdown);
                
                // Extract metadata
                const metadata = markdownConverter.extractMetadata(markdown);
                
                // Update page title and header
                document.title = `${metadata.title} - Business Analytics Hub`;
                document.getElementById('lecture-title').textContent = metadata.title;
                
                // Update breadcrumb
                updateBreadcrumb([
                    { name: 'Semester 1', link: 'semester.html?id=1' },
                    { name: metadata.course.replace(/\(.*?\)/g, '').trim(), link: `course.html?id=${courseId}` },
                    { name: `Lecture ${lectureNumber}` }
                ]);
                
                // Update metadata display
                updateMetadataDisplay(metadata, lectureNumber);
                
                // Update main content
                document.getElementById('markdown-content').innerHTML = html;
                
                // Generate and display table of contents
                const tocHTML = markdownConverter.generateTableOfContents();
                document.getElementById('table-of-contents').innerHTML = tocHTML;
                
                // Update progress
                updateProgress(lectureNumber);
                
                // Load related lectures
                loadRelatedLectures(courseId, lectureNumber);
                
                // Calculate reading time
                calculateReadingTime(markdown);
                
                // Re-apply syntax highlighting
                setTimeout(() => hljs.highlightAll(), 100);
                
                // Scroll to top
                window.scrollTo({ top: 0, behavior: 'smooth' });
                
            } catch (error) {
                console.error('Error loading lecture:', error);
                showErrorState(courseId, lectureNumber);
            }
        }

        // Update metadata display
        function updateMetadataDisplay(metadata, lectureNumber) {
            const metaContainer = document.getElementById('lecture-meta');
            
            metaContainer.innerHTML = `
                <div class="meta-item">
                    <i class="far fa-calendar"></i>
                    <span>${metadata.date || 'Not specified'}</span>
                </div>
                <div class="meta-item">
                    <i class="far fa-clock"></i>
                    <span>${metadata.duration || '1.5 hours'}</span>
                </div>
                <div class="meta-item">
                    <i class="fas fa-chalkboard-teacher"></i>
                    <span>${metadata.instructor || 'Instructor'}</span>
                </div>
                <div class="meta-item">
                    <i class="fas fa-book"></i>
                    <span>${metadata.course || 'Course'}</span>
                </div>
            `;
        }

        // Update progress display
        function updateProgress(currentLectureNum) {
            // For demo, assume total 15 lectures
            totalLectures = 15;
            const progress = (currentLectureNum / totalLectures) * 100;
            
            document.getElementById('progress-percent').textContent = `${Math.round(progress)}%`;
            document.getElementById('progress-fill-lecture').style.width = `${progress}%`;
            
            // Update navigation buttons
            document.getElementById('prev-lecture').disabled = currentLectureNum <= 1;
            document.getElementById('next-lecture').disabled = currentLectureNum >= totalLectures;
        }

        // Calculate reading time
        function calculateReadingTime(markdown) {
            const words = markdown.split(/\s+/).length;
            const minutes = Math.ceil(words / 200); // Average reading speed: 200 words/min
            
            document.getElementById('reading-time').textContent = `${minutes} min`;
        }

        // Load related lectures
        async function loadRelatedLectures(courseId, currentLectureNum) {
            const container = document.getElementById('related-lectures');
            
            // For demo, show neighboring lectures
            const relatedLectures = [];
            
            for (let i = Math.max(1, currentLectureNum - 2); i <= Math.min(15, currentLectureNum + 2); i++) {
                if (i !== currentLectureNum) {
                    relatedLectures.push({
                        number: i,
                        title: `Lecture ${i}`,
                        status: i < currentLectureNum ? 'completed' : 'upcoming',
                        isCurrent: i === currentLectureNum
                    });
                }
            }
            
            container.innerHTML = relatedLectures.map(lecture => `
                <a href="lecture.html?course=${courseId}&lecture=${lecture.number}" 
                   class="mini-lecture-card ${lecture.status} ${lecture.isCurrent ? 'current' : ''}">
                    <h4>${lecture.title}</h4>
                    <div class="mini-lecture-meta">
                        <span>${lecture.status === 'completed' ? '✓ Completed' : '↑ Upcoming'}</span>
                        <span>1.5 hours</span>
                    </div>
                </a>
            `).join('');
        }

        // Setup event listeners
        function setupEventListeners() {
            // Navigation buttons
            document.getElementById('prev-lecture').addEventListener('click', () => {
                if (currentLecture > 1) {
                    currentLecture--;
                    loadLecture(currentCourse, currentLecture);
                }
            });
            
            document.getElementById('next-lecture').addEventListener('click', () => {
                currentLecture++;
                loadLecture(currentCourse, currentLecture);
            });
            
            // PDF download button
            document.getElementById('download-pdf').addEventListener('click', generatePDF);
            
            // Table of contents scroll spy
            window.addEventListener('scroll', updateActiveTOCItem);
            
            // Smooth scroll for TOC links
            document.getElementById('table-of-contents').addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    e.preventDefault();
                    const targetId = e.target.getAttribute('href').substring(1);
                    const targetElement = document.getElementById(targetId);
                    
                    if (targetElement) {
                        const headerOffset = 100;
                        const elementPosition = targetElement.getBoundingClientRect().top;
                        const offsetPosition = elementPosition + window.pageYOffset - headerOffset;
                        
                        window.scrollTo({
                            top: offsetPosition,
                            behavior: 'smooth'
                        });
                    }
                }
            });
        }

        // Generate PDF
        async function generatePDF() {
            const button = document.getElementById('download-pdf');
            const originalText = button.innerHTML;
            
            // Show loading state
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating PDF...';
            button.disabled = true;
            
            try {
                await PDFGenerator.generateQuickPDF('markdown-content', document.getElementById('lecture-title').textContent);
            } catch (error) {
                console.error('PDF generation failed:', error);
                alert('Failed to generate PDF. Please try again.');
            } finally {
                // Restore button
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        // Update active TOC item based on scroll
        function updateActiveTOCItem() {
            const headings = document.querySelectorAll('.markdown-content h2, .markdown-content h3, .markdown-content h4');
            const tocLinks = document.querySelectorAll('.toc-list li a');
            
            let currentActive = null;
            
            headings.forEach((heading, index) => {
                const rect = heading.getBoundingClientRect();
                if (rect.top <= 150 && rect.bottom >= 150) {
                    currentActive = heading.id;
                }
            });
            
            // Update TOC active state
            tocLinks.forEach(link => {
                link.parentElement.classList.remove('active');
                if (link.getAttribute('href') === `#${currentActive}`) {
                    link.parentElement.classList.add('active');
                }
            });
        }

        // Show error state
        function showErrorState(courseId, lectureNumber) {
            document.getElementById('lecture-title').textContent = 'Lecture Not Found';
            
            document.getElementById('markdown-content').innerHTML = `
                <div class="empty-state" style="text-align: center; padding: 50px;">
                    <i class="fas fa-exclamation-circle fa-3x" style="color: var(--accent-color);"></i>
                    <h2 style="margin: 20px 0 10px 0;">Lecture ${lectureNumber} Not Found</h2>
                    <p style="margin-bottom: 30px; color: var(--gray-color);">
                        The lecture notes for this lecture haven't been created yet.
                    </p>
                    <div style="display: flex; gap: 15px; justify-content: center;">
                        <button class="btn-view" onclick="createNewLecture('${courseId}', ${lectureNumber})">
                            <i class="fas fa-plus-circle"></i> Create This Lecture
                        </button>
                        <button class="btn-view" onclick="window.location.href='course.html?id=${courseId}'">
                            <i class="fas fa-arrow-left"></i> Back to Course
                        </button>
                    </div>
                    
                    <div style="margin-top: 40px; text-align: left; background: #f8f9fa; padding: 20px; border-radius: 8px;">
                        <h3><i class="fas fa-info-circle"></i> How to Add Lecture Notes</h3>
                        <ol style="margin: 15px 0 15px 20px;">
                            <li>Create folder: <code>content/semester1/${courseId}/</code></li>
                            <li>Create file: <code>lecture${lectureNumber}.md</code></li>
                            <li>Use the template from <code>content/templates/lecture-template.md</code></li>
                            <li>Refresh this page to see your notes</li>
                        </ol>
                    </div>
                </div>
            `;
        }

        // Create new lecture
        function createNewLecture(courseId, lectureNumber) {
            const templateContent = `# Lecture ${lectureNumber}: [Enter Lecture Title Here]

**Date:** ${new Date().toLocaleDateString()}
**Duration:** 1.5 hours
**Instructor:** [Teacher Name]
**Course:** ${courseId}

---

## Learning Objectives
- Objective 1
- Objective 2
- Objective 3

## Key Concepts
1. **Concept 1:** Explanation
2. **Concept 2:** Explanation
3. **Concept 3:** Explanation

## Detailed Notes

### 1. Main Topic
Detailed explanation with examples.

### 2. Practical Applications
Real-world examples and case studies.

## Key Takeaways
1. Takeaway 1
2. Takeaway 2
3. Takeaway 3

---

*Lecture notes generated by Business Analytics Hub*`;

            // Create a downloadable template file
            const blob = new Blob([templateContent], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `lecture${lectureNumber}.md`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert(`Template downloaded! Save it as: content/semester1/${courseId}/lecture${lectureNumber}.md`);
        }

        // Set active navigation
        function setActiveNav(page) {
            const navLinks = document.querySelectorAll('.nav-links a');
            navLinks.forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href').includes(page)) {
                    link.classList.add('active');
                }
            });
        }
    </script>
    
    <style>
        /* Loading and error states */
        .loading-state {
            text-align: center;
            padding: 50px;
            color: var(--gray-color);
        }
        
        .loading-state i {
            font-size: 3rem;
            margin-bottom: 20px;
        }
        
        .empty-state {
            text-align: center;
            padding: 50px;
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 20px;
        }
        
        /* Code block styling */
        .hljs {
            border-radius: 5px;
            padding: 20px !important;
        }
        
        pre code.hljs {
            padding: 20px;
        }
        
        /* Responsive adjustments */
        @media (max-width: 992px) {
            .lecture-container {
                grid-template-columns: 1fr;
            }
            
            .toc-sidebar {
                position: static;
                max-height: none;
                margin-bottom: 30px;
            }
            
            .lecture-actions-bar {
                flex-direction: column;
                gap: 15px;
            }
            
            .action-buttons,
            .navigation-buttons {
                width: 100%;
            }
            
            .btn-print,
            .btn-download-full,
            .btn-prev,
            .btn-next {
                flex: 1;
            }
        }
        
        @media (max-width: 768px) {
            .lecture-content {
                padding: 20px;
            }
            
            .lecture-header h1 {
                font-size: 1.8rem;
            }
            
            .lecture-meta {
                flex-direction: column;
                gap: 10px;
            }
            
            .markdown-content h1 {
                font-size: 1.8rem;
            }
            
            .markdown-content h2 {
                font-size: 1.5rem;
            }
        }
    </style>
</body>
</html>